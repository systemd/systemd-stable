---
# vi: ts=2 sw=2 et:
# SPDX-License-Identifier: LGPL-2.1-or-later
# Simple boot tests that build and boot the mkosi images generated by the mkosi config files in mkosi.default.d/.
name: mkosi

on:
  push:
    branches:
      - main
      - v[0-9]+-stable
  pull_request:
    branches:
      - main
      - v[0-9]+-stable

permissions:
  contents: read

env:
  # Enable debug logging in systemd, but keep udev's log level to info,
  # since it's _very_ verbose in the QEMU task
  KERNEL_CMDLINE: "systemd.unit=mkosi-check-and-shutdown.service !quiet systemd.log_level=debug systemd.log_target=console udev.log_level=info systemd.default_standard_output=journal+console"

jobs:
  ci:
    runs-on: ubuntu-20.04
    concurrency:
      group: ${{ github.workflow }}-${{ matrix.distro }}-${{ github.ref }}
      cancel-in-progress: true
    strategy:
      fail-fast: false
      matrix:
        distro:
          - arch
          - debian
          - ubuntu
          - fedora
          - opensuse

    steps:
    - uses: actions/checkout@a12a3943b4bdde767164f792f33f40b04645d846
    - uses: systemd/mkosi@4d64fc8134f93d87ac584183e7762ac1d0efa0e5

    - name: Install
      run: sudo apt-get update && sudo apt-get install --no-install-recommends python3-pexpect python3-jinja2

    - name: Configure
      run: echo -e "[Distribution]\nDistribution=${{ matrix.distro }}\n" >mkosi.default

    - name: Build ${{ matrix.distro }}
      run: ./.github/workflows/run_mkosi.sh --build-environment=CI_BUILD=1 --kernel-command-line "${{ env.KERNEL_CMDLINE }}" build

    - name: Show ${{ matrix.distro }} image summary
      run: ./.github/workflows/run_mkosi.sh summary

    - name: Boot ${{ matrix.distro }} systemd-nspawn
      run: ./.github/workflows/run_mkosi.sh boot ${{ env.KERNEL_CMDLINE }}

    - name: Check ${{ matrix.distro }} systemd-nspawn
      run: ./.github/workflows/run_mkosi.sh shell bash -c "[[ -e /testok ]] || { cat /failed-services; exit 1; }"

    - name: Boot ${{ matrix.distro }} QEMU
      run: ./.github/workflows/run_mkosi.sh qemu

    - name: Check ${{ matrix.distro }} QEMU
      run: ./.github/workflows/run_mkosi.sh shell bash -c "[[ -e /testok ]] || { cat /failed-services; exit 1; }"
